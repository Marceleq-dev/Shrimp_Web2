<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shrimp Clicker ü¶ê</title>
  <style>
    :root{
      --bg1:#283048; --bg2:#859398; --card:#32323C99;
      --btn:#4e5d6c; --btn-hover:#607184; --btn-disabled:#333a41;
      --accent:#7dd3fc; 
    }
    html,body {height:100%; margin:0; position:relative; z-index:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#eee;}

    body {
        display: grid;
        grid-template-columns: 1fr minmax(300px, 980px) 1fr; 
        min-height: 100vh;
        gap: 20px;
        padding: 24px 0; 
    }

    .leaderboard-container {
        grid-column: 1 / 2;
        padding-left: 24px; 
        align-self: start; 
    }

    .game-container{
        grid-column: 2 / 3;
        width: 100%; 
        padding: 20px;
        text-align:center;
        margin: 0; 
    }

    @media (max-width: 980px) {
        body {
            grid-template-columns: 1fr minmax(300px, 100%) 1fr; 
            gap: 10px;
        }
    }
    @media (max-width: 600px) {
        body {
            grid-template-columns: 10px 1fr 10px; 
            padding: 10px 0;
        }
        .leaderboard-container {
            grid-column: 2 / 3; 
            order: 2; 
            padding-left: 0;
        }
        .game-container {
            grid-column: 2 / 3; 
            order: 1; 
            padding: 10px 0;
        }
        .upgrades {
            width: 100%;
        }
    }

    h1{margin:6px 0;text-shadow:0 2px 4px rgba(0,0,0,.7);}    
    .shrimp{width:200px;height:200px;background:url('https://static.vecteezy.com/system/resources/previews/036/161/836/non_2x/tiger-shrimp-on-a-transparent-background-free-png.png') no-repeat center/contain;margin:18px auto;cursor:pointer;transition:transform .08s ease;}
    .shrimp:active{transform:scale(.94);}    
    .stats{margin:10px 0;font-size:1.05rem;}
    .count {font-size:2rem;font-weight:700;display:inline-block;min-width:200px;transition:transform .2s;}
    .small{font-size:.9rem;color:#cfd8dc;}
    .upgrades{margin-top:20px;background:var(--card);display:inline-block;padding:18px 26px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.6);text-align:left;}
    .upgrade-btn{display:block;width:100%;text-align:left;padding:12px 16px;margin:8px 0;background-color:var(--btn);color:#f0f0f0;border:1px solid #62717a;border-radius:8px;cursor:pointer;transition:background .15s,transform .08s;}
    .upgrade-btn:hover:not(:disabled){background-color:var(--btn-hover);transform:translateX(4px);}
    .upgrade-btn:disabled{background-color:var(--btn-disabled);color:#777;cursor:not-allowed;}
    .upgrade-cost{float:right;font-weight:700;}
    .controls{margin-top:18px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
    .control-btn{background:#1f2937;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .control-btn:disabled{opacity:.5;cursor:not-allowed;}
    .floating-shrimp{position:absolute;width:48px;height:48px;background-size:contain;animation:floatUp 1.2s ease-out forwards;pointer-events:none;z-index:120;}
    @keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-100px) scale(.9)}}
    .click-effect{position:absolute;font-size:1.6rem;font-weight:700;color:#fff;text-shadow:0 0 6px #000;pointer-events:none;animation:floatText 1s ease-out forwards;z-index:130;}
    @keyframes floatText{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-80px)}}
    .flash-buy{animation:flash .35s linear}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(125,211,252,.55)}70%{box-shadow:0 0 0 16px rgba(125,211,252,0)}100%{box-shadow:none}}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .meta{font-size:.9rem;color:#cfd8dc}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000;opacity:0;pointer-events:none;transition:opacity .18s;}
    .modal.show{opacity:1;pointer-events:auto}
    .modal-card{background:#0f1724;padding:18px;border-radius:12px;color:#fff;min-width:280px;max-width:90%;box-shadow:0 8px 40px rgba(0,0,0,.6)}
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px}
    .shop-item{background:#071025;border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.04)}
    .shop-item img{width:100%;height:120px;object-fit:contain;border-radius:6px;background:#08202a;padding:6px}
    .shop-item button{margin-top:8px;width:100%}
    .owned-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b7; color:#012; font-weight:700;margin-top:8px}
    
    .leaderboard {
        text-align: left;
        background: rgba(17, 24, 39, 0.9); 
        padding: 16px;
        border-radius: 12px;
        color: #e6eef3;
        width: 100%;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); 
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .leaderboard h4 {
        margin: 0 0 12px 0;
        color: var(--accent); 
        font-size: 1.2em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }
    .leaderboard ol {
        list-style: none; 
        padding: 0;
        margin: 0;
        counter-reset: rank; 
    }
    .leaderboard ol li {
        counter-increment: rank; 
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        background-color: rgba(255, 255, 255, 0.05); 
        transition: background-color 0.2s;
        font-weight: 500;
    }
    .leaderboard ol li:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .leaderboard ol li::before {
        content: counter(rank); 
        font-weight: 700;
        min-width: 20px;
        text-align: center;
        margin-right: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #4b5563; 
        color: #fff;
    }

    .leaderboard ol li:nth-child(1)::before {
        background: #ffd700; 
        color: #333;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    }
    .leaderboard ol li:nth-child(2)::before {
        background: #c0c0c0; 
        color: #333;
    }
    .leaderboard ol li:nth-child(3)::before {
        background: #cd7f32; 
        color: #333;
    }

    .leaderboard .player-name {
        flex-grow: 1; 
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .leaderboard .score {
        font-weight: 700;
        color: var(--accent);
        margin-left: 10px;
        flex-shrink: 0; 
    }
    .leaderboard .date-meta {
        font-size: 0.75rem;
        color: #9aa6b2;
        margin-left: 10px;
        flex-shrink: 0;
    }
    .bump{animation:bump .18s ease}
    @keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.09)}100%{transform:scale(1)}}

    .falling-shrimp {
      position: fixed;
      top: -80px;
      width: 60px;
      height: 60px;
      background-size: contain;
      background-repeat: no-repeat;
      pointer-events: none;
      opacity: 0.55;
      z-index: -1;
      animation: fallShrimp linear forwards;
    }

    @keyframes fallShrimp {
      from { transform: translateY(-120px) rotate(0deg); }
      to   { transform: translateY(110vh) rotate(360deg); }
    }

  </style>
</head>
<body>
  
    <div class="leaderboard-container">
        <div class="leaderboard" id="leaderboard">
            <h4>Top Players</h4>
            <ol id="leaders"></ol>
            <div style="margin-top:8px;font-size:.85rem;color:#bfcfe0">Best Shrimp Count: <span id="bestCount">0</span></div>
        </div>
    </div>

    <div class="game-container">
      <h1>ü¶ê Shrimp Clicker ü¶ê</h1>
      <div style="font-size:.95rem;color:#bfcfe0;margin-top:6px">Player: <span id="playerNameDisplay">Guest</span></div>

      <div id="shrimp" class="shrimp" title="Click me!"></div>

      <div class="stats">
        <div class="row" style="justify-content:center;align-items:flex-end">
          <div style="text-align:center">
            <div class="small">Shrimps</div>
            <div id="counter" class="count">0</div>
          </div>
          <div style="text-align:left">
            <div class="small">Per Click</div>
            <div id="spc" class="count">1</div>
          </div>
          <div style="text-align:left">
            <div class="small">Per Second</div>
            <div id="sps" class="count">0</div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px;display:flex;justify-content:center;gap:18px;align-items:center;flex-wrap:wrap">
        <div style="text-align:center">
          <div class="small">Cash</div>
          <div id="cashDisplay" class="count">$0.00</div>
        </div>
        <div style="text-align:center">
          <div class="small">Shrimp Price</div>
          <div id="priceDisplay" class="count">$0.00</div>
        </div>
      </div>

      <div class="controls">
        <button id="saveBtn" class="control-btn">Save</button>
        <button id="loadBtn" class="control-btn">Load</button>
        <button id="submitLeaderBtn" class="control-btn">Submit Score</button>
        <button id="shopBtn" class="control-btn">Shop</button>
        <button id="sellBtn" class="control-btn">Sell Shrimps</button>
        <div style="align-self:center;color:#cbd5e1">Owned skins: <span id="ownedCount">0</span></div>
      </div>

      <div class="upgrades" id="upgradesBox" aria-live="polite">
        <h3>Upgrades</h3>

        <button id="upg-net" class="upgrade-btn">
          <span class="upgrade-title">Stronger Net (+1 SPC)</span>
          <span class="upgrade-cost" id="cost-net">20</span>
        </button>

        <button id="upg-sps1" class="upgrade-btn">
          <span class="upgrade-title">Small Fry Factory (+1 SPS)</span>
          <span class="upgrade-cost" id="cost-sps1">100</span>
        </button>

        <button id="upg-sps2" class="upgrade-btn">
          <span class="upgrade-title">Medium Shrimp Farm (+10 SPS)</span>
          <span class="upgrade-cost" id="cost-sps2">2000</span>
        </button>

        <button id="upg-sps3" class="upgrade-btn">
          <span class="upgrade-title">Mega Shrimp Reactor (+100 SPS)</span>
          <span class="upgrade-cost" id="cost-sps3">50000</span>
        </button>

        <div style="margin-top:12px" class="meta">
          Tip: Upgrades unlock visually when you reach 50% of their base cost.
        </div>
      </div>
      
    </div>
    <div id="nickModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Choose a nickname</h3>
      <p>Please enter a player nickname. This will be used for the leaderboard.</p>
      <input id="playerNameInput" type="text" placeholder="Type your nickname" style="width:100%;padding:8px;border-radius:6px;border:none;margin-top:8px" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="playerNameSave" class="control-btn">Save</button>
      </div>
    </div>
  </div>

 
  <div id="shopModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Shrimp Skins Shop</h3>
      <p>Spend shrimps to permanently unlock skins. Click "Equip" to apply a skin.</p>

      <div id="shopGrid" class="shop-grid"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="closeShop" class="control-btn">Close</button>
      </div>
    </div>
  </div>

<script>
/**
 * REPLACING HARDCODED KEYS WITH PLACEHOLDERS FOR GITHUB SECRETS.
 * If you use a GitHub Action to deploy, you can use a "search and replace"
 * step to inject the values from secrets.JSONBIN_BIN_ID and secrets.JSONBIN_SECRET_KEY.
 */
const JSONBIN_SECRET_KEY = '[[JSONBIN_SECRET_KEY]]'; 
const JSONBIN_BIN_ID = '[[JSONBIN_BIN_ID]]';  

// Fallback logic for local development or if replacement didn't happen
const FINAL_SECRET_KEY = JSONBIN_SECRET_KEY.startsWith('[[') ? '' : JSONBIN_SECRET_KEY;
const FINAL_BIN_ID = JSONBIN_BIN_ID.startsWith('[[') ? '' : JSONBIN_BIN_ID;

const SAVE_KEY = 'shrimp_clicker_save_v4';
const PLAYER_NAME_KEY = 'shrimp_clicker_player_v1';
const LEADERBOARD_API = `https://api.jsonbin.io/v3/b/${FINAL_BIN_ID}`;

let shrimp = 0;
let spc = 1;
let sps = 0;
let bestShrimp = 0;

let cash = 0;               
let shrimpPrice = 0.25;     
let marketMultiplier = 1.0; 
let marketTrend = 0;        

const upgrades = {
  net:   { base: 20,    count: 0, boost: 1,  type: "spc", visible: true },
  sps1:  { base: 100,   count: 0, boost: 1,  type: "sps", visible: false },
  sps2:  { base: 2000,  count: 0, boost: 10, type: "sps", visible: false },
  sps3:  { base: 50000, count: 0, boost: 100,type: "sps", visible: false }
};

const SKINS = [
  { id: 'default', name: 'Default Shrimp', img: 'https://static.vecteezy.com/system/resources/previews/036/161/836/non_2x/tiger-shrimp-on-a-transparent-background-free-png.png', cost: 0 },
  { id: 'tempura', name: 'King Shrimp', img: 'https://www.auraaquarium.com/cdn/shop/products/131_300x300.png?v=1678421939', cost: 250 },
  { id: 'pimp', name: 'Pimp Shrimp', img: 'https://preview.redd.it/ptktkt94of651.jpg?width=640&crop=smart&auto=webp&s=ece45242378a8f10824026038c66fa6891eb2eaf', cost: 100000 },
];

let unlockedSkins = new Set(['default']);
let equippedSkin = 'default';
let playerName = localStorage.getItem(PLAYER_NAME_KEY) || '';

function formatNumber(num) {
  if (!isFinite(num)) return '0';
  const abs = Math.abs(num);
  if (abs < 1000) return Math.floor(num).toString();
  const abbrev = [
    { v: 1e18, suf: 'E' },
    { v: 1e15, suf: 'P' },
    { v: 1e12, suf: 'T' },
    { v: 1e9,  suf: 'B' },
    { v: 1e6,  suf: 'M' },
    { v: 1e3,  suf: 'K' }
  ];
  for (const a of abbrev) {
    if (abs >= a.v) {
      return (num / a.v).toFixed( (abs / a.v >= 100) ? 0 : (abs / a.v >= 10 ? 1 : 2) ) + a.suf;
    }
  }
  return Math.floor(num).toString();
}

function upgradeCost(upg) {
  return Math.ceil(upg.base * Math.pow(1.15, upg.count));
}

function recalcSPS() {
  let total = 0;
  for (const k in upgrades) {
    if (upgrades[k].type === 'sps') total += upgrades[k].count * upgrades[k].boost;
  }
  sps = +total.toFixed(6);
}

const counterEl = document.getElementById('counter');
const spcEl = document.getElementById('spc');
const spsEl = document.getElementById('sps');
const bestCountEl = document.getElementById('bestCount');
const leadersList = document.getElementById('leaders');
const ownedCountEl = document.getElementById('ownedCount');
const shrimpEl = document.getElementById('shrimp');
const submitLeaderBtn = document.getElementById('submitLeaderBtn');
const playerNameDisplay = document.getElementById('playerNameDisplay');
const nickModal = document.getElementById('nickModal');
const playerNameInput = document.getElementById('playerNameInput');
const playerNameSave = document.getElementById('playerNameSave');
const cashDisplay = document.getElementById('cashDisplay');
const priceDisplay = document.getElementById('priceDisplay');

function getSkinImg(id){
  const s = SKINS.find(x=>x.id===id);
  return s ? s.img : SKINS[0].img;
}

function spawnShrimpImage(x,y){
  const img = document.createElement('div');
  img.className='floating-shrimp';
  img.style.left = (x - 24) + 'px';
  img.style.top = (y - 24) + 'px';
  img.style.backgroundImage = `url('${getSkinImg(equippedSkin)}')`;
  document.body.appendChild(img);
  setTimeout(()=>img.remove(),1300);
}

function showClickEffect(x,y,txt){
  const el = document.createElement('div');
  el.className = 'click-effect';
  el.style.left = (x + 10) + 'px';
  el.style.top = (y - 10) + 'px';
  el.textContent = txt;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

function bump(el){
  if(!el) return;
  el.classList.remove('bump');
  void el.offsetWidth;
  el.classList.add('bump');
}

function updateShrimpImage(){
  shrimpEl.style.backgroundImage = `url('${getSkinImg(equippedSkin)}')`;
}

function updateUI(){
  counterEl.textContent = formatNumber(Math.floor(shrimp));
  spcEl.textContent = formatNumber(spc);
  spsEl.textContent = formatNumber(sps);
  cashDisplay.textContent = '$' + Number(cash).toFixed(2);
  priceDisplay.textContent = '$' + Number(shrimpPrice).toFixed(2);

  if (shrimp > bestShrimp) { bestShrimp = shrimp; } 
  if (bestCountEl) {
      bestCountEl.textContent = formatNumber(Math.floor(bestShrimp)); 
  }

  for (const key in upgrades) {
    const up = upgrades[key];
    const cost = upgradeCost(up);
    const costEl = document.getElementById('cost-' + key);
    if(costEl) costEl.textContent = '$' + formatNumber(cost);
    const btn = document.getElementById('upg-' + key);
    if(btn) {
      btn.disabled = cash < cost;
      if (!up.visible && shrimp >= up.base * 0.5) up.visible = true;
      btn.style.display = up.visible ? 'block' : 'none';
    }
  }

  ownedCountEl.textContent = String(unlockedSkins.size);
  if(submitLeaderBtn) submitLeaderBtn.disabled = (Math.floor(bestShrimp) <= 0) || !playerName || playerName.trim().length===0;
  updateShrimpImage();
}

function tickMarket(){
  const r = Math.random();
  if (r < 0.3) marketTrend = -1;
  else if (r > 0.7) marketTrend = 1;
  else marketTrend = 0;

  const drift = (Math.random() - 0.5) * 0.06; 
  const jump = (Math.random() < 0.005) ? ((Math.random() - 0.5) * 0.6) : 0; 
  marketMultiplier = Math.max(0.3, Math.min(3.0, marketMultiplier + drift * marketTrend + jump));

  shrimpPrice = Math.max(0.01, 0.5 * marketMultiplier + (Math.random() - 0.5) * 0.5);

  if (priceDisplay) priceDisplay.textContent = '$' + Number(shrimpPrice).toFixed(2);
}

setInterval(tickMarket, 1400); 

function spawnBackgroundShrimp() {
  const amount = Math.min(50, Math.max(1, Math.floor(sps)));

  for (let i = 0; i < amount; i++) {
    const el = document.createElement("div");
    el.className = "falling-shrimp";

    const size = 40 + Math.random() * 60;
    el.style.width = size + "px";
    el.style.height = size + "px";

    el.style.left = Math.random() * window.innerWidth + "px";
    el.style.backgroundImage = `url('${getSkinImg(equippedSkin)}')`;

    const duration = 3 + Math.random() * 4;
    el.style.animationDuration = duration + "s";

    document.body.appendChild(el);
    setTimeout(() => el.remove(), duration * 1000);
  }
}

setInterval(() => {
  spawnBackgroundShrimp();
}, 1000);

const shopModal = document.getElementById('shopModal');
const shopGrid = document.getElementById('shopGrid');
const shopCloseBtn = document.getElementById('closeShop');

function openShop(){
  renderShop();
  shopModal.classList.add('show');
  shopModal.setAttribute('aria-hidden','false');
}
  if(playerNameDisplay) playerNameDisplay.textContent = playerName || 'Guest';
function closeShop(){
  shopModal.classList.remove('show');
  shopModal.setAttribute('aria-hidden','true');
}

function renderShop(){
  shopGrid.innerHTML = '';
  SKINS.forEach(skin => {
    const item = document.createElement('div');
    item.className = 'shop-item';

    const img = document.createElement('img');
    img.src = skin.img;
    img.alt = skin.name;

    const title = document.createElement('div');
    title.textContent = skin.name;

    const cost = document.createElement('div');
    cost.className = 'meta';
    cost.textContent = skin.cost > 0 ? `${formatNumber(skin.cost)} shrimps` : 'Free';

    item.appendChild(img);
    item.appendChild(title);
    item.appendChild(cost);

    const btnWrap = document.createElement('div');
    btnWrap.style.marginTop = '8px';
    item.appendChild(btnWrap);

    const equipBtn = document.createElement('button');
    equipBtn.className = 'control-btn';
    equipBtn.textContent = 'Equip';
    equipBtn.style.display = 'none';
    equipBtn.addEventListener('click', () => {
      if (!unlockedSkins.has(skin.id)) return;
      equippedSkin = skin.id;
      saveGame(true);
      renderShop();
      updateUI();
    });

    const buyBtn = document.createElement('button');
    buyBtn.className = 'control-btn';
    buyBtn.textContent = `Buy (${formatNumber(skin.cost)})`;
    buyBtn.style.display = 'none';

    buyBtn.addEventListener('click', () => {
      if (shrimp < skin.cost) { alert('Not enough shrimps to buy this skin.'); return; }
      if (!confirm(`Buy "${skin.name}" for ${formatNumber(skin.cost)} shrimps?`)) return;
      shrimp = Math.floor(shrimp - skin.cost);
      unlockedSkins.add(skin.id);
      equippedSkin = skin.id;
      saveGame(true);
      renderShop();
      updateUI();
      alert(`Purchased and equipped "${skin.name}"!`);
    });

    if (unlockedSkins.has(skin.id)) {
      const ownedBadge = document.createElement('div');
      ownedBadge.className = 'owned-badge';
      ownedBadge.textContent = (equippedSkin === skin.id) ? 'Equipped' : 'Owned';
      btnWrap.appendChild(ownedBadge);

      if (equippedSkin !== skin.id) {
        equipBtn.style.display = 'inline-block';
        btnWrap.appendChild(equipBtn);
      }
    } else {
      buyBtn.disabled = shrimp < skin.cost;
      buyBtn.style.display = 'inline-block';
      btnWrap.appendChild(buyBtn);
    }

    shopGrid.appendChild(item);
  });
}

function buyUpgrade(id, animate=true) {
  const up = upgrades[id];
  if (!up) return;
  const cost = upgradeCost(up);
  if (cash < cost) return;
  cash = Math.max(0, +(cash - cost).toFixed(2));
  up.count++;
  if (up.type === 'spc') spc += up.boost;
  recalcSPS();
  const btn = document.getElementById('upg-' + id);
  if(btn && animate) { btn.classList.add('flash-buy'); setTimeout(()=>btn.classList.remove('flash-buy'),380); }
  bump(counterEl); bump(spcEl); updateUI();
}

function sellAllShrimps(){
  const amount = Math.floor(shrimp);
  if (amount <= 0) { alert('You have no shrimps to sell.'); return; }
  const earned = +(amount * shrimpPrice).toFixed(2);
  shrimp = Math.floor(shrimp - amount);
  cash = +(cash + earned).toFixed(2);
  updateUI();
  alert(`Sold ${amount} shrimps for $${earned.toFixed(2)}.`);
}

function sellShrimpsN(n){
  const amount = Math.floor(n);
  if (amount <= 0 || amount > shrimp) return 0;
  const earned = +(amount * shrimpPrice).toFixed(2);
  shrimp = Math.floor(shrimp - amount);
  cash = +(cash + earned).toFixed(2);
  updateUI();
  return earned;
}

document.getElementById('shrimp').addEventListener('click', (e) => {
  shrimp = Math.floor(shrimp + spc);
  spawnShrimpImage(e.clientX, e.clientY);
  showClickEffect(e.pageX, e.pageY, `+${formatNumber(spc)}`);
  bump(counterEl); updateUI();
});

document.getElementById('upg-net').addEventListener('click', ()=> buyUpgrade('net'));
document.getElementById('upg-sps1').addEventListener('click', ()=> buyUpgrade('sps1'));
document.getElementById('upg-sps2').addEventListener('click', ()=> buyUpgrade('sps2'));
document.getElementById('upg-sps3').addEventListener('click', ()=> buyUpgrade('sps3'));

document.getElementById('shopBtn').addEventListener('click', openShop);
shopCloseBtn.addEventListener('click', closeShop);
document.getElementById('sellBtn').addEventListener('click', sellAllShrimps);

setInterval(() => {
  if (sps > 0) {
    shrimp += sps / 10;
    updateUI();
  }
}, 100);

function attemptAutoUpgrade(){
  try{
    const cheapCandidates = [];
    for(const key in upgrades){
      const up = upgrades[key];
      const cost = upgradeCost(up);
      if(cash >= cost) cheapCandidates.push({key, cost, value: up.boost / Math.max(1,cost), boost: up.boost, type: up.type});
    }
    if(cheapCandidates.length===0) return;
    cheapCandidates.sort((a,b)=> b.value - a.value || a.cost - b.cost);
    buyUpgrade(cheapCandidates[0].key, false);
  }catch(e){ console.error('Auto-upgrade error', e); }
}

setInterval(()=>{
  attemptAutoUpgrade();
}, 60_000);

function saveGame(manual=false){
  const save = {
    shrimp: Math.floor(shrimp),
    spc, sps, bestShrimp,
    cash: +(cash.toFixed(2)),
    shrimpPrice: +(shrimpPrice.toFixed(4)),
    marketMultiplier: +(marketMultiplier.toFixed(4)),
    upgrades:{}, timestamp:Date.now(),
    unlockedSkins: Array.from(unlockedSkins),
    equippedSkin,
    playerName
  };
  for(const k in upgrades) save.upgrades[k] = {count: upgrades[k].count, visible: upgrades[k].visible};
  localStorage.setItem(SAVE_KEY, JSON.stringify(save));
  if(manual){ document.getElementById('saveBtn').textContent='Saved'; setTimeout(()=>document.getElementById('saveBtn').textContent='Save',900); }
}
function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;
  try{
    const obj = JSON.parse(raw);
    shrimp = obj.shrimp || 0; spc = obj.spc || 1; sps = obj.sps || 0; bestShrimp = obj.bestShrimp || bestShrimp;
    cash = obj.cash || cash || 0;
    shrimpPrice = obj.shrimpPrice || shrimpPrice || 0.25;
    marketMultiplier = obj.marketMultiplier || marketMultiplier || 1.0;
    if(obj.upgrades){ for(const k in upgrades){ if(obj.upgrades[k]){ upgrades[k].count=obj.upgrades[k].count||0; upgrades[k].visible=obj.upgrades[k].visible??upgrades[k].visible; }} }
    if (obj.unlockedSkins && Array.isArray(obj.unlockedSkins)) {
      unlockedSkins = new Set(obj.unlockedSkins);
    } else {
      unlockedSkins = new Set(['default']);
    }
    if (obj.equippedSkin) equippedSkin = obj.equippedSkin;
    if (obj.playerName) { playerName = obj.playerName; localStorage.setItem(PLAYER_NAME_KEY, playerName); }
    recalcSPS(); updateUI(); return true;
  }catch(e){ console.error('Load failed',e); return false;}
}
document.getElementById('saveBtn').addEventListener('click', ()=> saveGame(true));
document.getElementById('loadBtn').addEventListener('click', ()=> { const ok = loadGame(); if(!ok) alert('No save found.'); });
setInterval(()=>saveGame(false),5000);
document.getElementById('submitLeaderBtn').addEventListener('click', submitScoreToLeaderboard);
if(playerNameSave){
  playerNameSave.addEventListener('click', ()=>{
    const v = (playerNameInput && playerNameInput.value) ? playerNameInput.value.trim() : '';
    playerName = v || 'Player';
    localStorage.setItem(PLAYER_NAME_KEY, playerName);
    if (nickModal) { nickModal.classList.remove('show'); nickModal.setAttribute('aria-hidden','true'); }
    updateUI();
  });
}

function processLeaderboard(list, newEntry = null) {
    if (!list) list = [];
    
    if (newEntry && newEntry.shrimps > 0) {
        const existingIndex = list.findIndex(e => e.name === newEntry.name);
        if (existingIndex > -1) {
            if (newEntry.shrimps > list[existingIndex].shrimps) {
                list[existingIndex] = newEntry;
            }
        } else {
            list.push(newEntry);
        }
    }

    list.sort((a, b) => b.shrimps - a.shrimps);
    
    return list.slice(0, 10);
}


async function loadLeaderboard() {
  if (!FINAL_SECRET_KEY || !FINAL_BIN_ID) return [];
  try {
    const response = await fetch(LEADERBOARD_API + '/latest', {
      method: 'GET',
      headers: {
        'X-Master-Key': FINAL_SECRET_KEY, 
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) throw new Error(`Failed to fetch leaderboard: ${response.status} ${response.statusText}`);
    
    const data = await response.json();
    return Array.isArray(data.record.leaders) ? data.record.leaders : [];
  } catch (e) {
    console.error('Error loading global leaderboard:', e);
    leadersList.innerHTML = '<li style="color:#f87171; justify-content:center;">Error connecting to global leaderboard.</li>';
    return []; 
  }
}

async function renderLeaderboard() {
  const list = await loadLeaderboard();
  leadersList.innerHTML = '';
  
  if (list.length === 0) {
    leadersList.innerHTML = '<li style="color:#9aa6b2; justify-content:center;">No entries yet or keys not set.</li>';
  } else {
    list.slice(0, 10).forEach((e) => {
      const li = document.createElement('li');
      
      const score = e.shrimps ? formatNumber(e.shrimps) : 'N/A';
      const playerName = e.name ? e.name : 'Unknown';
      const dateStr = e.date ? new Date(e.date).toLocaleDateString() : 'N/A';
      
      li.innerHTML = `
          <span class="player-name">${playerName}</span> 
          <span class="score">${score} shrimps</span>
          <span class="date-meta">(${dateStr})</span>
      `;
      leadersList.appendChild(li);
    });
  }
}

async function submitScoreToLeaderboard() {
  if (!FINAL_SECRET_KEY || !FINAL_BIN_ID) {
      alert("WARNING: Global leaderboard keys are not configured in your environment.");
      return;
  }
  
  if (!Number.isFinite(bestShrimp) || Math.floor(bestShrimp) <= 0) {
    alert('You must have a score greater than 0 to submit.');
    return;
  }
  
  let name = playerName;
  if (!name || name.trim().length === 0) {
      name = prompt('Enter name for Top Players leaderboard (leave blank for "Player")') || 'Player';
      playerName = name;
      localStorage.setItem(PLAYER_NAME_KEY, playerName);
      if(playerNameDisplay) playerNameDisplay.textContent = playerName;
  }
  
  if (name.trim().length === 0) return; 

  const newEntry = {
    name: name,
    shrimps: Math.floor(bestShrimp),
    date: Date.now()
  };
  
  try {
    const currentList = await loadLeaderboard();
    const updatedLeaders = processLeaderboard(currentList, newEntry);
    
    const response = await fetch(LEADERBOARD_API, {
      method: 'PUT', 
      headers: { 
        'Content-Type': 'application/json',
        'X-Master-Key': FINAL_SECRET_KEY, 
        'X-Bin-Versioning': 'false' 
      },
      body: JSON.stringify({ leaders: updatedLeaders }) 
    });
    
    if (!response.ok) throw new Error(`Server returned status: ${response.status} ${response.statusText}`);
    
    alert(`Score of ${formatNumber(newEntry.shrimps)} submitted and updated globally!`);
    await renderLeaderboard(); 
  } catch (e) {
    console.error('Error submitting score:', e);
    alert('Failed to submit score.');
  }
}

setInterval(renderLeaderboard, 30000); 

(function init(){
  for(const k in upgrades){ upgrades[k].visible=(k==='net')||upgrades[k].visible;}
  const loaded=loadGame();
  if(!loaded) recalcSPS();
  if (!unlockedSkins.has('default')) unlockedSkins.add('default');
  updateUI();
  
  renderLeaderboard(); 

  if(!playerName){
    if(nickModal && playerNameInput){
      nickModal.classList.add('show'); nickModal.setAttribute('aria-hidden','false');
      playerNameInput.focus();
    }
  }
})();

document.addEventListener('keydown', (e)=>{ 
  if(e.key==='s'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); saveGame(true); }
  if(e.key==='l'&&(e.ctrlKey||e.metaKey)){ e.preventDefault(); loadGame(); }
  if(e.key==='p'&& (e.ctrlKey||e.metaKey)){ e.preventDefault(); submitScoreToLeaderboard(); }
});

</script>
</body>
</html>
